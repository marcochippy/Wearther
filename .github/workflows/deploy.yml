name: Deploy to Plesk

on:
  push:
    branches:
      - main

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24.6.0

      - name: Install dependencies
        run: npm ci
        working-directory: ./Frontend

      - name: Create frontend .env
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > ./Frontend/.env

      - name: Build application
        run: npm run build
        working-directory: ./Frontend

      - name: Deploy Frontend to Plesk
        uses: celleb/plesk-deployer@v1.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_FRONTEND_KEY }}
          ftp-username: ${{ vars.FTP_USERNAME_FRONTEND }}
          ftp-server: ${{ vars.FTP_SERVER }}
          files-to-copy: './Frontend/dist ./Frontend/package.json ./Frontend/package-lock.json'
          remote-dir: './app/httpdocs'
          node-version: 24.6.0
          package-manager: npm
          npm-install: false
          restart: false
          clean-remote-dir: true

  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24.6.0

      - name: Deploy backend .env
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.FTP_USERNAME_BACKEND }}@${{ vars.FTP_SERVER }} \
          "echo 'PORT=${{ secrets.PORT }}' > ./app/httpdocs/backend/.env
            echo 'KEY_WEATHERBIT=${{ secrets.KEY_WEATHERBIT }}' >> ./app/httpdocs/backend/.env
            echo 'URL_WEATHERBIT=${{ secrets.URL_WEATHERBIT }}' >> ./app/httpdocs/backend/.env
            echo 'ZIP_WEATHERBIT=${{ secrets.ZIP_WEATHERBIT }}' >> ./app/httpdocs/backend/.env
            echo 'KEY_ACCUWEATHER=${{ secrets.KEY_ACCUWEATHER }}' >> ./app/httpdocs/backend/.env
            echo 'URL_ACCUWEATHER=${{ secrets.URL_ACCUWEATHER }}' >> ./app/httpdocs/backend/.env
            echo 'MONGO_URI=${{ secrets.MONGO_URI }}' >> ./app/httpdocs/backend/.env
            echo 'GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}' >> ./app/httpdocs/backend/.env
            echo 'SPA_ORIGIN=${{ secrets.SPA_ORIGIN }}' >> ./app/httpdocs/backend/.env
            echo 'NODE_ENV=production' >> ./app/httpdocs/backend/.env"

      - name: Install dependencies
        run: npm ci
        working-directory: ./Backend

      - name: Build backend
        run: npm run build
        working-directory: ./Backend

      - name: Deploy Backend to Plesk
        uses: celleb/plesk-deployer@v1.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_BACKEND_KEY }}
          ftp-username: ${{ vars.FTP_USERNAME_BACKEND }}
          ftp-server: ${{ vars.FTP_SERVER }}
          files-to-copy: './Backend/dist ./Backend/package.json ./Backend/package-lock.json'
          remote-dir: './httpdocs'
          node-version: 24.6.0
          package-manager: npm
          npm-install: false
          restart: false
          clean-remote-dir: true
